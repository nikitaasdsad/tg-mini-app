<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
<title>–ì–æ—Ç–æ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è</title>
<style>
  :root{
    --bg:#0f1113; --card:#121316; --muted:#bfc7cd; --accent:#2EA44F;
    --glass: rgba(255,255,255,0.03);
  }
  html,body{height:100%; margin:0; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); color:#fff}
  .wrap{max-width:1100px; margin:12px auto; padding:12px; box-sizing:border-box;}
  header{display:flex; align-items:center; gap:12px; margin-bottom:12px}
  h1{font-size:18px;margin:0}
  .grid{display:grid; grid-template-columns: repeat(2,1fr); gap:12px;}
  @media(min-width:900px){ .grid{grid-template-columns: repeat(4,1fr);} }
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; overflow:hidden; position:relative; box-shadow:0 6px 20px rgba(0,0,0,0.6);}
  .thumb{width:100%; aspect-ratio: 4/5; object-fit:cover; display:block}
  .overlay{position:absolute; left:0; right:0; bottom:0; background:linear-gradient(0deg, rgba(0,0,0,0.75), rgba(0,0,0,0.15)); padding:10px; transform: translateY(100%); transition: transform .22s ease;}
  .card:hover .overlay, .card.show-overlay .overlay{ transform: translateY(0%); }
  .title{font-weight:600; font-size:14px; margin-bottom:6px}
  .short{font-size:13px; color:var(--muted); line-height:1.25}
  .btn-row{display:flex; gap:8px; margin-top:8px}
  .btn{padding:8px 10px; border-radius:10px; border:0; cursor:pointer; font-weight:600}
  .btn.ghost{background:transparent; border:1px solid rgba(255,255,255,0.06); color:#fff}
  .btn.primary{background:var(--accent); color:#06140a}
  /* detail view */
  .detail{display:none}
  .detail.active{display:block}
  .detail .viewer{background:var(--card); border-radius:12px; padding:10px;}
  .viewer .imgwrap{width:100%; height:min(62vh,700px); background:#000; display:flex; align-items:center; justify-content:center; border-radius:8px; overflow:hidden}
  .viewer img{width:100%; height:100%; object-fit:cover}
  .nav{display:flex; gap:8px; justify-content:center; margin-top:10px}
  .pager{display:flex; gap:6px; justify-content:center; margin-top:8px}
  .dot{width:8px;height:8px;border-radius:50%; background:rgba(255,255,255,0.15)}
  .dot.active{background:var(--accent)}
  .caption{color:var(--muted); margin-top:10px}
  /* mobile touch-friendly */
  .card{touch-action:manipulation}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>üìö –ì–æ—Ç–æ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è</h1>
  </header>

  <!-- ========== MAIN GALLERY ========== -->
  <div id="mainView">
    <div class="grid" id="grid"></div>
  </div>

  <!-- ========== DETAIL VIEW ========== -->
  <div id="detailView" class="detail">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
      <div style="font-weight:600" id="detailTitle">Title</div>
      <div>
        <button id="detailBack" class="btn ghost">üîô –ù–∞–∑–∞–¥</button>
        <button id="rentBtn" class="btn primary">–ê—Ä–µ–Ω–¥–æ–≤–∞—Ç—å</button>
      </div>
    </div>

    <div class="viewer">
      <div class="imgwrap" id="imgWrap">
        <img id="detailImg" src="" alt="image"/>
      </div>
      <div class="nav">
        <button id="prevBtn" class="btn ghost">‚óÄÔ∏è</button>
        <button id="nextBtn" class="btn ghost">‚ñ∂Ô∏è</button>
      </div>
      <div class="pager" id="pager"></div>
      <div class="caption" id="detailCaption"></div>
    </div>
  </div>
</div>

<script>
/* ======= Data: –∑–∞–º–µ–Ω—è–π URL –∏ —Ç–µ–∫—Å—Ç—ã –Ω–∞ —Å–≤–æ–∏ ======= */
const ALL_SCENARIOS = [
  { title: "–í–∏–Ω—Ç–∞–∂–Ω—ã–π –ø–æ—Ä—Ç—Ä–µ—Ç", short: "–ú—è–≥–∫–∏–π —Å–≤–µ—Ç, —Ç—ë–ø–ª—ã–µ —Ç–æ–Ω–∞.", caption: "–í–∏–Ω—Ç–∞–∂–Ω—ã–π –ø–æ—Ä—Ç—Ä–µ—Ç: –º—è–≥–∫–∏–π —Å–≤–µ—Ç, —Ç—ë–ø–ª—ã–µ —Ç–æ–Ω–∞. –ö–æ—Ä–æ—Ç–∫–∞—è –ø—Ä–µ–¥—ã—Å—Ç–æ—Ä–∏—è: –≥–µ—Ä–æ–∏–Ω—è ‚Äî –Ω–∞—Å–ª–µ–¥–Ω–∏—Ü–∞ —Å—Ç–∞—Ä–æ–≥–æ –æ—Å–æ–±–Ω—è–∫–∞.", images:[
      "https://picsum.photos/seed/vintage1/1200/1600",
      "https://picsum.photos/seed/vintage2/1200/1600",
      "https://picsum.photos/seed/vintage3/1200/1600"
  ]},
  { title: "–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –≥–µ—Ä–æ–∏–Ω—è", short: "–Ø—Ä–∫–∞—è —Å—Ç—Ä–∏–∂–∫–∞ –∏ –ø–∏—Ä—Å–∏–Ω–≥.", caption: "–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å—Ç–∏–ª—å: —è—Ä–∫–∞—è —Å—Ç—Ä–∏–∂–∫–∞, –ø–∏—Ä—Å–∏–Ω–≥, –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–π –º–∞–∫–∏—è–∂. –ü—Ä–µ–¥—ã—Å—Ç–æ—Ä–∏—è: —É–ª–∏—á–Ω—ã–π –∞—Ä—Ç–∏—Å—Ç —Å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–æ–º.", images:[
      "https://picsum.photos/seed/alt1/1200/1600",
      "https://picsum.photos/seed/alt2/1200/1600",
      "https://picsum.photos/seed/alt3/1200/1600"
  ]},
  { title: "–ù–µ–æ–Ω–æ–≤—ã–π –∫–∏–±–µ—Ä–ø–∞–Ω–∫", short: "–ù–µ–æ–Ω, –≥–æ—Ä–æ–¥—Å–∫–æ–π –¥–æ–∂–¥—å.", caption: "–ö–∏–±–µ—Ä–ø–∞–Ω–∫: –Ω–µ–æ–Ω–æ–≤—ã–µ –∞–∫—Ü–µ–Ω—Ç—ã, –≤–ª–∞–∂–Ω—ã–π –≥–æ—Ä–æ–¥—Å–∫–æ–π –ø–µ–π–∑–∞–∂, —Å–∏–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–∞—Å—Ç. –ö–æ—Ä–æ—Ç–∫–∞—è –ø—Ä–µ–¥—ã—Å—Ç–æ—Ä–∏—è: —Ö–∞–∫–µ—Ä-–ø–æ—ç—Ç.", images:[
      "https://picsum.photos/seed/cyber1/1200/1600",
      "https://picsum.photos/seed/cyber2/1200/1600",
      "https://picsum.photos/seed/cyber3/1200/1600"
  ]},
  { title: "–ú–æ—Ä—Å–∫–æ–π –ø–æ—Ä—Ç—Ä–µ—Ç", short: "–°–≤–µ–∂–∏–π –≤–æ–∑–¥—É—Ö, –≤–µ—Ç–µ—Ä –≤ –≤–æ–ª–æ—Å–∞—Ö.", caption: "–ú–æ—Ä—Å–∫–æ–π –ø–æ—Ä—Ç—Ä–µ—Ç: –ø–∞—Å–º—É—Ä–Ω—ã–π –±–µ—Ä–µ–≥, —Å–æ–ª—ë–Ω—ã–π –≤–µ—Ç–µ—Ä, –∑–∞–¥—É–º—á–∏–≤—ã–π –≤–∑–≥–ª—è–¥.", images:[
      "https://picsum.photos/seed/sea1/1200/1600",
      "https://picsum.photos/seed/sea2/1200/1600",
      "https://picsum.photos/seed/sea3/1200/1600"
  ]},
];
/* ================================================ */

const grid = document.getElementById('grid');
const mainView = document.getElementById('mainView');
const detailView = document.getElementById('detailView');
const detailImg = document.getElementById('detailImg');
const detailTitle = document.getElementById('detailTitle');
const detailCaption = document.getElementById('detailCaption');
const pager = document.getElementById('pager');

/* single set of state variables (no duplicates) */
let chosenListIndices = [];  // –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –≤ ALL_SCENARIOS
let chosenList = [];
let currentGlobalIndex = null;
let currentScenarioIndex = 0;
let slideIndex = 0;
let slideshowTimer = null;

/* Utility: pick N random distinct indices */
function pickRandomIndices(arrLength, n){
  const out = [];
  const idxs = Array.from({length: arrLength}, (_,i)=>i);
  while(out.length < n && idxs.length){
    const i = Math.floor(Math.random() * idxs.length);
    out.push(idxs.splice(i,1)[0]);
  }
  return out;
}

/* Render main grid (4 random scenarios) */
function renderMain(){
  grid.innerHTML = '';
  const take = Math.min(4, ALL_SCENARIOS.length);
  chosenListIndices = pickRandomIndices(ALL_SCENARIOS.length, take);
  chosenList = chosenListIndices.map(i => ALL_SCENARIOS[i]);

  chosenList.forEach((sc, localIdx) => {
    const card = document.createElement('div');
    card.className = 'card';
    const img = document.createElement('img');
    img.className = 'thumb';
    img.src = sc.images[0];
    img.alt = sc.title;
    const overlay = document.createElement('div');
    overlay.className = 'overlay';
    overlay.innerHTML = `<div class="title">${sc.title}</div><div class="short">${sc.short}</div>`;
    card.appendChild(img);
    card.appendChild(overlay);

    card.addEventListener('click', (e)=>{
      if(window.innerWidth <= 900){
        if(!card.classList.contains('show-overlay')){
          card.classList.add('show-overlay');
          setTimeout(()=> card.classList.remove('show-overlay'), 3500);
          return;
        }
      }
      openDetail(localIdx);
    });

    img.addEventListener('dblclick', ()=> openDetail(localIdx));
    grid.appendChild(card);
  });
}

/* Open detail for local index */
function openDetail(localIdx){
  currentScenarioIndex = localIdx;
  slideIndex = 0;
  currentGlobalIndex = chosenListIndices[localIdx];
  const sc = chosenList[localIdx];
  detailTitle.textContent = sc.title;
  detailCaption.textContent = sc.caption;
  detailImg.src = sc.images[slideIndex];
  renderPager(sc.images.length);
  mainView.style.display = 'none';
  detailView.classList.add('active');
  startSlideshow();
  window.scrollTo({top:0, behavior:'smooth'});
}

/* Return to main */
function backToMain(){
  stopSlideshow();
  detailView.classList.remove('active');
  mainView.style.display = '';
}

/* Slideshow */
function renderPager(len){
  pager.innerHTML = '';
  for(let i=0;i<len;i++){
    const d = document.createElement('div');
    d.className = 'dot' + (i===slideIndex ? ' active' : '');
    pager.appendChild(d);
  }
}
function nextSlide(){
  const sc = chosenList[currentScenarioIndex];
  slideIndex = (slideIndex + 1) % sc.images.length;
  detailImg.src = sc.images[slideIndex];
  renderPager(sc.images.length);
}
function prevSlide(){
  const sc = chosenList[currentScenarioIndex];
  slideIndex = (slideIndex - 1 + sc.images.length) % sc.images.length;
  detailImg.src = sc.images[slideIndex];
  renderPager(sc.images.length);
}
function startSlideshow(){
  stopSlideshow();
  slideshowTimer = setInterval(nextSlide, 5000);
}
function stopSlideshow(){
  if(slideshowTimer){ clearInterval(slideshowTimer); slideshowTimer = null;}
}

/* Hook UI buttons */
document.getElementById('detailBack').addEventListener('click', backToMain);
document.getElementById('prevBtn').addEventListener('click', ()=>{ stopSlideshow(); prevSlide(); startSlideshow(); });
document.getElementById('nextBtn').addEventListener('click', ()=>{ stopSlideshow(); nextSlide(); startSlideshow(); });

/* Rent button: send data to bot via Telegram.WebApp.sendData (full payload + global idx) */
document.getElementById('rentBtn').addEventListener('click', ()=>{
  const sc = chosenList[currentScenarioIndex];
  const payloadObj = {
    action: "rent",
    scenario_idx: currentGlobalIndex,
    scenario: {
      title: sc.title,
      short: sc.short,
      caption: sc.caption,
      images: sc.images
    }
  };
  const payloadStr = JSON.stringify(payloadObj);
  if(window.Telegram && Telegram.WebApp && typeof Telegram.WebApp.sendData === 'function'){
    try{
      Telegram.WebApp.sendData(payloadStr);
      Telegram.WebApp.close();
    }catch(e){
      console.error("Telegram WebApp error:", e);
      alert("–û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –±–æ—Ç–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å: " + e.message);
    }
  } else {
    alert("–ê—Ä–µ–Ω–¥–æ–≤–∞—Ç—å (–ª–æ–∫–∞–ª—å–Ω–æ): " + payloadStr);
  }
});

/* Init Telegram WebApp if available */
if(window.Telegram && Telegram.WebApp){
  try{ Telegram.WebApp.expand(); }catch(e){}
  try{ Telegram.WebApp.MainButton.hide(); }catch(e){}
}

/* Init page */
renderMain();
</script>
</body>
</html>
